\documentclass[a4paper]{article}
\usepackage{a4}
\usepackage[T1]{fontenc}
\usepackage[latin1]{inputenc}
%\usepackage{doublespace}
%\usepackage{hyperref}

\bibliographystyle{apalike}
\input{macro}

\begin{document}

\section*{A flexible system for specifying agricultural field management strategies}

\begin{abstract}
  Modelling the farmer is hard, a flexible system is needed.  Such a
  system is present in Daisy.  The two main abstractions in the system
  is actions, and conditions. Actions are divided into field
  operations, waiting for conditions, and two special facilities for
  performing multiple actions in sequence, or at the same time.
  Conditions either directly examine the state of the simulation, or
  are Boolean operations on other conditions.  Some conditions examine
  hard-coded parts of the state directly (in particular time), others
  allows allow arithmetic operations on a user defined subset of the
  state.  By combining these actions and conditions, quite flexible
  starategies can be described.  The system is easy to implement using
  modern elementary computer science principles, and have been
  succesfully used for diverse purposes.
\end{abstract}

\tableofcontents

\section{Modelling the farmer}

A conceptual problem for modelling the ecosystem of a field is how to
model the farmer.  The farmer is a human being, and those are
notoriously difficult to model, especially when they may have access
to the model themselves[REF].

\paragraph{The past} When using the model on historic data, the
problem is much simplified.  The management actions have already been
performed.  The model is simply feed with a list of mangement
operations, at the same level of detail as the model itself.  This is
the approach traditionally taken by simulation models[REF].  Running
the model on historic data is useful when analysing a field
experiment, and when trying to extract data that have not been
directly measured, such as nitrogen leaching.

\paragraph{The present} When using the model as part of a decision
support system (DSS), we have access to historic data, and need to
advice the farmer of what decision to take now.  We thus also here
avoid the need to model the farmer.  The advice tends to be hard coded
heuristics on top of either a simulation model [REF] or purely
empirical relations on the input data [REF].  An optimization model
may find the optimal management for the field.  Optimization models
are very computationally intensive, and are most usefyl for simple
system descriptions.  For field management, an additional obstacle for
optimization models is that the weather is not known in advance by the
farmer.

\paragraph{The future} Sometimes simulations models are used for
predicting the effect of some change imposed on the field.  This
change can be to the soil (eg.\ depletion of soil carbon[REF]),
climate (e.g. effect of global warming[REF]) or management (e.g.
introduction of irrigation[REF]).  These scenarios can also be build
on historical data, with proper alternation.  A simulation model may
be able to simulate the soil carbon change itself.  Global warming may
be immitated by simply scaling historical data.  And irrigation may be
imposed on top of an exsisting management discription.  The problem
occurs when these changes affect the basis for the historical
management decisions.  Soil carbon depletion and irrigation are both
likely to increase the need of fertilization, and a warmer climate
will almost always affect crop phenology, and therefore harvest time.
This means the sensible management decisions in the hypothetical
scenario will likely be different from the historical data the
scenario is based upon.  This means that we either need to stop the
scenario simulation regularly and make the new managment decision
based on the new state of the system, or use an automated decision
making system, i.e.\ a model of the farmer.

\paragraph{Decision making systems} A sufficiently detailed DSS can be
used as a decision making system in a scanario simulation, simply by
assuming that the farmer always follow the suggestions.  Scenario
simulations can also be used for developing the DSS, by examining what
would happen if the farmer followed the suggestions.  The decision
making system that most faithfully models the farmer in a specific
scenario varies a lot.  Where a DSS will often try to optimize
production within legal boundaries, some scenarios (such a soil carbon
fate) will be best served by decisions that reflect common or
traditional practise.  As both the legal boundaries, common practise,
and the selection of crops varies between locations, and change over
time in the same location,, having a flexible system to describe the
strategy for making decisions is very useful.  Such a system, together
with a robust mechanistic model of the field, can also be used for
optimizing the strategy in a DSS.

In this paper we will describe a flexible system for specifying
agricultural field management strategies.  The system is implemented
as part of the Daisy agro-ecological simulation model, which we will
describe first.

\section{Daisy}

Daisy\cite{daisy-fertilizer,daisy-ems} is a mechanistic simulation
model of an agro-ecological system.  It simulates water, nitrogen,
carbon and energy below and above the soil surface.  Above the soil
surface there is one or more crop, competing for light, water and
nutrients.  Plant growth is fueled by available light, and limited by
available nitrogen, water and respiration.  The accumulated growth is
divided into stem, leaf, storage organs, and roots.  For light
competition, the canopy is divided into vertical layers, where the
crops with leafs in the uppper layers may shadow the crops with leafs
in the lower layer.  Below the soil surface, the soil is also divided
into vertical (for now) numerical layers.  Transport of water in the
soil is done with Richard's equations for the matrix, suplemented with
a simple macropore model.  Solute transport is done with
convection-dispersion (and macropores).  The user is able to choose
simpler models for transport, when computational speed is more
important than accuracy.  Organic matter in the soils is divided into
multiple pools, by default 6, and both short-term (days) and long-term
(decades) dynamics have been validated [REF].

The current focus on Daisy development is on 2-dimensional transport
in the soil, macropores, pesticide and pollutant fate, as well as
partial root zone drying irrigation with hormonal signalling in the
crop, and the relationship between nitrogen content and photosynthesis.

\section{Concepts}

In this section we will brifly explain the contral primiives in the
Daisy decision making system, they will be illustrated further with
examples in the following section.  The two central concepts in our
decision making system are \emph{actions} and \emph{conditions}.  An
action has a \emph{duration} (in simulation time), and may both
examine and change the \emph{state} of the simulation.  A condition is
either true or false, has no duration, and may examine but not modify
the state of the simulation.

The actions can roughly be divided into three subcategories: The first
type of actions simulate field operations, such as plowing or
harvesting.  The second type of action is to do nothing, waiting for
some condition to be true.  The third type of action combines other
actions.  The \texttt{activity} action perfom a list of actions
sequentionally, when the first action is finished, begin the next, and
so on.  The \texttt{while} action perform a list of actions
simultaniously.  For the duration of the first action, also perform
all the remaining actions.  The \texttt{if} action takes a condition
and two actions as arguments, if the condition is true, it will
perform the first action, otherwise the second.

The conditions can similarily be divided into subcategories.  The
simple conditions directly test some aspect of the simulation state,
such as whether the crop has passed a certeain development stage, or
if the soil moisture at a specified depth is a above a certain
threshold.  The logic conditions allow the user to combine other
conditions with Boolean operations, such as \texttt{or}, \texttt{and}
and \texttt{not}.  Finally, the \texttt{extern} condition allows full
access to both state and arithmetic operations on the state, through
the indirection of a user specified log file.

\section{Historical management}

Our first example is with historical data, where we know what the
farmer did, and when.
\begin{verbatim}
(manager activity
  (wait (at 1987 3 20 1))
  (plowing)
  (wait (at 1987 4 4 1))
  (fertilize (N25S (weight 100.0 [kg N/ha])))
  (wait (at 1987 4 5 1))
  (sow "Spring Barley")
  (wait (at 1987 9 5 1))
  (harvest "Spring Barley"))
\end{verbatim}
First a few words about the notation.  Everything is fully
parenthesised, with the name comming after after the opening
parenthesis, followed by the arguments separated by whitespace.
Floating point numbers are followed by a dimension in square brackets,
cardinals are not.  Strings containing whitespace must be surrounded
by quotation marks.

The string ``\texttt{manager}'' is the name of a parameter in the
Daisy model, here we specify the value for that parameter.  The Daisy
model takes other parameters, such as ``\texttt{column}'' to specify
the properties of the field, and ``\texttt{weather}'', but those are
not the topic of this article.  The next string is
``\texttt{activity}'', which is the action that takes a list of
actions as arguments, and perform them sequentially.  In this case
there are 8 arguments, as each argument is surrounded by
parenthesizes.

The format of the action list is that we wait for a specific
condition, and then perform a field operation action
(\texttt{plowing}, \texttt{fertilize}, \texttt{sow} and
\texttt{harvest}).  The ``\texttt{wait}'' action takes a condition as
argument, in this setup the same each time.  The ``\texttt{at}''
condition takes four cardinal numbers as arguments, representing year,
month, day in month, and hour.  It is true when the simulation time
reaches that point.  The ``\texttt{fertilize}'' action takes a
fertilizer as an argument, and the ``\texttt{sow}'' and
``\texttt{harvest}'' actions both takes a crop as an argument.

Not all the fascilities in this example are build into Daisy.  The
``\texttt{N25S}'' fertilizer, the ``\texttt{Spring Barley}'' crop, and
even the ``\texttt{plowing}'' action are defined in parameterization
libraries that are distributed with Daisy in a user editable format.
The user also is able to define and name parameterizations for later
use, which leads us to our next example.

\section{Crop management}
    
\begin{verbatim}
  (defaction sbarley activity
    (wait (mm_dd 10 1))
    (plowing)
    ...)

  (defaction rotation activity
    sbarley sbarley potato)

  (manager rotation)
\end{verbatim}
   
\section{Simple state}


\begin{verbatim}
  (defcondition trafficable ...)

  (defaction sbarley activity
    (wait (mm_dd 10 1))
    (wait (or trafficable (mm_dd 11 1)))
    (plowing)
    ....
    (wait (or (crop_DS_above all 2.0) (mm_dd 9 1)))
    (harvest "Spring Barley"))
\end{verbatim}

Defcond.  Fjernede året.  Moden.  Logic.

\section{Concurrency}

\begin{verbatim}
  (defaction irrigation ...)

  (defaction irrigated_sbarley activity
    (while sbarley
       irrigation))
\end{verbatim}

\section{Advanced state}

\begin{verbatim}
  (deflog DSS extern ...)

  (defnumber N_min ...)

  (defaction sbarley ... (extern DSS))
\end{verbatim}

\section{Implementation}

Since all expressions are fully parenthesised, the input language is
implemented with a trivial hand-written recursive-descend parser with
a single token lookahead, and no backtracking.  Alternatively, if one
is willing to accept a somewhat bulkier notation, a ready-to-use XML
based parser could be used.

The base concepts \texttt{action}, \emph{condition}, \texttt{boolean},
and \emph{number} are all represented by pure base class, and the
specific actions, conditions, etc.\ by concrete classes derived from
the base.  The accessor functions for action and conditions needs to
take the simulation state as an argument (for condition it can be a
read-only argument).

Each concrete class is respsonsible for registering itself with name,
constructor and parameters with a factory pattern.  This registry is
also use by the parser.  A global table of extern logs is used for
making the log information available in the numerical expressions
within the ``extern'' condition.

\section{Applications}

Has been succesfully used in (examples)...

\begin{itemize}
\item Is rutinely used with historical management data for analysing
  experiments.
\item Loop: Skriv noget om opskalering.
\item VVM: Godkendelse for skift af brug.
\item FertOrgaNic: Brug som DSS
\item Min OM-init artikel: Langtidssimulering for initialisering af OM
  puljer. 
\end{itemize}

\section{Conclusion}


Vi er bare så gode.

\section{Acknowledgements}

DINA, FertOrgaNic.

\addcontentsline{toc}{section}{\numberline{}Bibliography}
\bibliography{daisy}

\end{document}
